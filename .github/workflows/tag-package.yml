name: Tag Build

permissions:
  contents: write

on:
  push:
    tags:
      - '*'

jobs:
  build:
    strategy:
      matrix:
        include:
          # Unbundled variants (without JRE)
          - os: ubuntu-latest
            maven_profile: os:any-os-full
            asset_suffix: full
            package_type: unbundled
          - os: ubuntu-latest
            maven_profile: os:any-os-lite
            asset_suffix: lite
            package_type: unbundled
          - os: windows-latest
            maven_profile: os:windows-amd64
            asset_suffix: windows-amd64
            package_type: unbundled
          - os: macos-latest
            maven_profile: os:macos-arm64
            asset_suffix: macos-arm64
            package_type: unbundled
          - os: ubuntu-latest
            maven_profile: os:linux-amd64
            asset_suffix: linux-amd64
            package_type: unbundled
          - os: ubuntu-latest
            maven_profile: os:linux-arm64
            asset_suffix: linux-arm64
            package_type: unbundled
          # Bundled variants (with JRE)
          - os: windows-latest
            maven_profile: os:windows-amd64
            asset_suffix: windows-amd64
            package_type: bundled
          - os: macos-latest
            maven_profile: os:macos-arm64
            asset_suffix: macos-arm64
            package_type: bundled
          - os: ubuntu-latest
            maven_profile: os:linux-amd64
            asset_suffix: linux-amd64
            package_type: bundled
          - os: ubuntu-latest
            maven_profile: os:linux-arm64
            asset_suffix: linux-arm64
            package_type: bundled
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
      - name: Package with Maven
        shell: bash
        run: |
          if [ "${{ matrix.package_type }}" = "bundled" ]; then
            mvn -B clean package -P pkg:bundled,${{ matrix.maven_profile }}
          else
            mvn -B clean package -P pkg:unbundled,${{ matrix.maven_profile }}
          fi
      - name: Resolve project version
        id: project_version
        shell: bash
        run: |
          VERSION=$(mvn -B help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
      - name: Prepare artifact
        shell: bash
        env:
          VERSION: ${{ steps.project_version.outputs.version }}
          SUFFIX: ${{ matrix.asset_suffix }}
          PACKAGE_TYPE: ${{ matrix.package_type }}
        run: |
          mkdir -p dist
          # æŸ¥æ‰¾å®žé™…ç”Ÿæˆçš„æ–‡ä»¶
          find dat-cli/target -name "*.tar.gz" -type f

          if [ "$PACKAGE_TYPE" = "bundled" ]; then
            # Bundledç‰ˆæœ¬ä½¿ç”¨ -bundled åŽç¼€
            SRC="dat-cli/target/dat-cli-${VERSION}-${SUFFIX}-bundled.tar.gz"
            if [ -f "$SRC" ]; then
              DEST="dist/dat-cli-${VERSION}-${SUFFIX}-bundled.tar.gz"
              cp "$SRC" "$DEST"
              echo "Found bundled artifact: $SRC"
            else
              echo "ERROR: Bundled artifact not found: $SRC"
              exit 1
            fi
          else
            # Unbundledç‰ˆæœ¬
            SRC="dat-cli/target/dat-cli-${VERSION}-${SUFFIX}.tar.gz"
            if [ -f "$SRC" ]; then
              DEST="dist/dat-cli-${VERSION}-${SUFFIX}.tar.gz"
              cp "$SRC" "$DEST"
              echo "Found unbundled artifact: $SRC"
            else
              echo "ERROR: Unbundled artifact not found: $SRC"
              exit 1
            fi
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dat-cli-${{ matrix.asset_suffix }}-${{ matrix.package_type }}
          path: dist/*

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´åŽ†å²æ¥èŽ·å–PRä¿¡æ¯
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: List all artifacts
        run: |
          find dist -type f -name "*.tar.gz"
      - name: Generate Release Notes
        id: release_notes
        run: |
          # èŽ·å–æœ€æ–°çš„tagä¿¡æ¯
          TAG_NAME="${{ github.ref_name }}"

          # èŽ·å–è¯¥tagå¯¹åº”çš„commit
          COMMIT_SHA=$(git rev-list -n 1 "$TAG_NAME")

          echo "## Release $TAG_NAME" > release_notes.md
          echo "" >> release_notes.md
          echo "**å‘å¸ƒæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release_notes.md
          echo "" >> release_notes.md

          # èŽ·å–ä¸Šä¸€ä¸ªtagï¼ˆç”¨äºŽæ¯”è¾ƒå˜æ›´ï¼‰
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "### ðŸ“ å˜æ›´å†…å®¹ ($PREVIOUS_TAG â†’ $TAG_NAME)" >> release_notes.md
            echo "" >> release_notes.md

            # èŽ·å–ä¸¤ä¸ªtagä¹‹é—´çš„commits
            COMMITS=$(git log --pretty=format:"%H" "$PREVIOUS_TAG..$TAG_NAME")

            if [ -n "$COMMITS" ]; then
              # æå–PRä¿¡æ¯å’Œåˆå¹¶çš„commits
              echo "#### ðŸ”„ åˆå¹¶çš„Pull Requests:" >> release_notes.md
              echo "" >> release_notes.md

              # èŽ·å–åŒ…å«PRä¿¡æ¯çš„commits
              git log --pretty=format:"%s %b" "$PREVIOUS_TAG..$TAG_NAME" | grep -E "(Merge pull request|#PR)" | while read -r commit_msg; do
                # æå–PRå·ç 
                PR_NUMBER=$(echo "$commit_msg" | grep -oE '#[0-9]+' | head -1 | sed 's/#//')
                if [ -n "$PR_NUMBER" ]; then
                  echo "- PR #$PR_NUMBER" >> release_notes.md
                fi
              done

              echo "" >> release_notes.md
              echo "#### ðŸ“‹ æäº¤åŽ†å²:" >> release_notes.md
              echo "" >> release_notes.md

              # æ·»åŠ è¯¦ç»†çš„æäº¤ä¿¡æ¯
              git log --pretty=format:"- [%h] %s" "$PREVIOUS_TAG..$TAG_NAME" >> release_notes.md
            else
              echo "æ— å˜æ›´è®°å½•" >> release_notes.md
            fi
          else
            echo "### ðŸŽ‰ é¦–æ¬¡å‘å¸ƒ" >> release_notes.md
            echo "" >> release_notes.md
            echo "è¿™æ˜¯é¡¹ç›®çš„ç¬¬ä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬ã€‚" >> release_notes.md
          fi

          echo "" >> release_notes.md
          echo "### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž" >> release_notes.md
          echo "" >> release_notes.md
          echo "æœ¬å‘å¸ƒåŒ…å«ä»¥ä¸‹å˜ä½“ï¼š" >> release_notes.md
          echo "" >> release_notes.md
          echo "- **full**: å®Œæ•´ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½" >> release_notes.md
          echo "- **lite**: è½»é‡ç‰ˆæœ¬ï¼Œä»…åŒ…å«æ ¸å¿ƒåŠŸèƒ½" >> release_notes.md
          echo "- **bundled**: æ‰“åŒ…ç‰ˆæœ¬ï¼ŒåŒ…å«JREè¿è¡Œæ—¶" >> release_notes.md
          echo "- **unbundled**: æœªæ‰“åŒ…ç‰ˆæœ¬ï¼Œéœ€è¦å•ç‹¬å®‰è£…JavaçŽ¯å¢ƒ" >> release_notes.md
          echo "" >> release_notes.md
          echo "è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿå’Œéœ€æ±‚é€‰æ‹©åˆé€‚çš„ç‰ˆæœ¬ä¸‹è½½ã€‚" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "*æ­¤å‘å¸ƒç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*" >> release_notes.md

          # è¾“å‡ºrelease noteså†…å®¹
          echo "RELEASE_NOTES<<EOF" >> "$GITHUB_OUTPUT"
          cat release_notes.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        shell: bash
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*.tar.gz
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
